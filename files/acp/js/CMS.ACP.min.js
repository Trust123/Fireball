if(!CMS)var CMS={};CMS.ACP={};CMS.ACP.Content={};CMS.ACP.Content.AddDialog=Class.extend({_proxy:null,_cache:{},_dialog:null,init:function(){this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});$(".jsContentAddButton").click($.proxy(this._click,this))},_click:function(b){b.preventDefault();var a=$(b.currentTarget);this._proxy.setOption("data",{actionName:"getContentTypes",className:"cms\\data\\page\\PageAction",objectIDs:[a.data("objectID")],parameters:{position:a.data("position"),parentID:a.data("parentID")}});this._proxy.sendRequest()},_show:function(a){this._dialog=$('<div id="contentAddDialog">'+this._cache[a]+"</div>").appendTo(document.body);this._dialog.wcfDialog({title:WCF.Language.get("cms.acp.content.add")})},_success:function(a){this._cache[a.returnValues.pageID]=a.returnValues.template;this._show(a.returnValues.pageID)}});CMS.ACP.Content.Type={};CMS.ACP.Content.Type["de.codequake.cms.content.type.columns"]=Class.extend({_addButton:null,_columnCount:0,_columnData:null,_container:null,_maxColumnCount:5,_minColumnCount:2,_minColumnWidth:20,_mouseDifference:0,init:function(b){this._columnData=[];this._addButton=$(".jsAddColumn");this._container=$("#columnContainer");for(var a=0;a<this._minColumnCount||a<b.length;a++)this._addColumn(b[a]||Math.round(100/this._minColumnCount));this._container.mouseup($.proxy(this._mouseup,this));this._addButton.click($.proxy(function(a){a.preventDefault();if(this._addColumn(0)){var b=Math.round(100/this._columnCount);this._setWidth(this._columnCount,b)}},this))},_addColumn:function(d){if(this._columnCount==this._maxColumnCount)return false;this._columnCount++;var b=$('<div class="grid" data-column-number="'+this._columnCount+'"></div>').appendTo(this._container),c=$("<div></div>").appendTo(b),a=$('<div class="gridNumber"></div>').appendTo(c);$("<span>"+this._columnCount+"</span>").appendTo(a);$('<input type="number" name="contentData[columnData][]" min="'+this._minColumnWidth+'" />').keydown($.proxy(this._preventSubmit,this)).change($.proxy(this._change,this)).appendTo(a);$('<button type="button">'+WCF.Language.get("wcf.global.button.delete")+"</button>").click($.proxy(this._deleteClick,this)).appendTo(a);$('<div class="gridResize"></div>').mousedown($.proxy(this._mousedown,this)).appendTo(b);this._columnData.push(d);this._updateGUI();return true},_change:function(d){var a=$(d.currentTarget),b=parseInt(a.parents(".grid").data("columnNumber")),c=parseInt(a.val());this._setWidth(b,c)},_deleteClick:function(c){var b=$(c.currentTarget),a=parseInt(b.parents(".grid").data("columnNumber"));this._deleteColumn(a)},_deleteColumn:function(a){if(this._columnCount==this._minColumnCount){console.debug("[CMS.ACP.Content.Type['de.codequake.cms.content.type.columns']] Couldn't delete column '"+a+"', reached min column count.");return}var b=a+1;if(b>this._columnCount)b=a-1;var d=this._columnData[a-1],c=this._columnData[b-1]+d;this._columnData.splice(a-1,1);this._container.children(":nth-child("+a+")").remove();this._columnCount--;if(b>a)b--;this._columnData[b-1]=c;this._updateGUI()},_mousedown:function(b){b.preventDefault();var a=$(b.currentTarget),c=a.parent();this._mouseDifference=b.originalEvent.clientX-(a.offset().left+a.innerWidth())+$(window).scrollLeft();this._container.mousemove($.proxy(this._mousemove,this,c))},_mousemove:function(c,e){var a=c.data("columnNumber"),d=e.pageX-c.offset().left-this._mouseDifference,b=Math.round(d/this._container.width()*100);b!=this._columnData[a-1]&&this._setWidth(a,b)},_mouseup:function(){this._container.unbind("mousemove")},_preventSubmit:function(a){if(a.keyCode==$.ui.keyCode.ENTER){a.preventDefault();this._change(a)}},_updateGUI:function(){for(var b,c,a=1;a<=this._columnCount;a++){b=this._container.children(":nth-child("+a+")");c=this._columnData[a-1];b.data("columnNumber",a);b.innerWidth(c+"%");b.find("span").text(a);b.find("input").val(c).prop("max",100-this._minColumnWidth*(this._columnCount-1))}if(this._columnCount==this._maxColumnCount)this._addButton.prop("disabled",true);else this._addButton.prop("disabled",false);if(this._columnCount<=this._minColumnCount)this._container.find("button").prop("disabled",true);else this._container.find("button").prop("disabled",false)},_setWidth:function(d,c){if(d>this._columnCount){console.debug("[CMS.ACP.Content.Type['de.codequake.cms.content.type.columns']] Couldn't set column width for column '"+d+"', out of boundary.");return}if(c==this._columnData[d-1])return true;var g=false,a,b;if(c<this._minColumnWidth)return false;if(this._columnCount==1){this._columnData[0]=c;this._container.children().innerWidth(c+"%");return true}b=1;do{a=d+b;b++}while(c>this._columnData[d-1]&&a<=this._columnCount&&this._columnData[a-1]<=this._minColumnWidth);if(c>this._columnData[d-1]&&(a>this._columnCount||this._columnData[a-1]<=this._minColumnWidth)){b=1;do{a=d-b;b++}while(a>1&&this._columnData[a-1]<=this._minColumnWidth);if(a<1||this._columnData[a-1]<=this._minColumnWidth)return false}var f=c;for(b=1;b<=this._columnCount;b++)if(b!==d&&b!==a)f+=this._columnData[b-1];var e=100-f;if(e<this._minColumnWidth){g=c;e=this._minColumnWidth;c=100-(f+e-c)}this._columnData[d-1]=c;this._columnData[a-1]=e;this._updateGUI();g&&this._setWidth(d,g)}});CMS.ACP.File={};CMS.ACP.File.Details=Class.extend({_cache:{},_didInit:false,_proxy:null,init:function(){if(!this._didInit){this._didInit=true;this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});WCF.DOMNodeInsertedHandler.addCallback("CMS.ACP.File.Details",$.proxy(this.init,this))}$(".jsFileDetails:not(.jsFileDetailsEnabled)").addClass("jsFileDetailsEnabled").click($.proxy(this._click,this))},_click:function(b){var a=$(b.currentTarget).data("fileID");if(this._cache[a]===undefined){this._proxy.setOption("data",{actionName:"getDetails",className:"cms\\data\\file\\FileAction",objectIDs:[a]});this._proxy.sendRequest()}else this._cache[a].wcfDialog("open")},_success:function(a){this._cache[a.returnValues.fileID]=$(a.returnValues.template).hide().appendTo("body");this._cache[a.returnValues.fileID].wcfDialog({title:a.returnValues.title})}});CMS.ACP.File.ImageRatio=Class.extend({_ratio:1,init:function(a){new WCF.Action.Proxy({autoSend:true,data:{actionName:"getSize",className:"cms\\data\\file\\FileAction",objectIDs:[a]},success:$.proxy(this._success,this)});$("#width").change($.proxy(this._calculateHeight,this));$("#height").change($.proxy(this._calculateWidth,this))},_calculateHeight:function(){var a=$("#width"),b=a.val()/this._ratio;$("#height").val(Math.round(b))},_calculateWidth:function(){var a=$("#height"),b=a.val()*this._ratio;$("#width").val(Math.round(b))},_success:function(a){this._ratio=a.returnValues.width/a.returnValues.height}});CMS.ACP.File.Picker=Class.extend({_currentlyOpenCategory:0,_dialog:null,_inputName:"",_options:null,_proxy:null,_selectButton:null,_selected:null,init:function(c,d,b,e){this._selectButton=c;this._inputName=d;this._selected=b||{};this._options=$.extend(true,{multiple:false,fileType:""},e);this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});var a=this._selectButton.parents("form");if(!a.length){console.debug("[CMS.ACP.File.Picker] Unable to determine form for file picker, aborting.");return}a.submit($.proxy(this._submit,this));this._selectButton.click($.proxy(this._openPicker,this));this._updateSelectedFilesList()},selectFiles:function(a,e){if(!this._options.multiple){var d=Object.keys(a),f=a;a={};a[d[0]]=f[d[0]]}var c;for(var b in a){if(!a.hasOwnProperty(b))continue;c=a[b];if(this._selected[b]===undefined){this._selected[b]=c;e!==false&&this._dialog.find('tr[data-file-id="'+b+'"]').find("input").prop("checked",true)}}this._updateSelectedFilesList()},_dropdownCategoryClick:function(b){var a=$(b.currentTarget).data("categoryID");this._openCategory(a)},_inputClick:function(f){var a=$(f.currentTarget),d=a.parents("tr"),b=a.val();if(a.is(":checked")){var e={fileID:b,title:d.data("fileTitle"),formattedFilesize:d.data("fileFormattedSize")};this._selected[b]=e}else delete this._selected[b];if(!this._options.multiple){new CMS.ACP.File.ImageRatio(a.val());var c=this;$.each(c._selected,function(b){if(b!=a.val())delete c._selected[b]})}this._updateSelectedFilesList()},_openCategory:function(a){var b=this._dialog.find('.tabularBox[data-category-id="'+a+'"]');if(b.length){this._currentlyOpenCategory=a;this._dialog.find(".tabularBox").hide();b.show();$dropdownMenu=WCF.Dropdown.getDropdownMenu($(".filePickerCategoryDropdown").wcfIdentify());$dropdownMenu.find("li.active").removeClass("active");$dropdownMenu.find('li[data-category-id="'+a+'"]').addClass("active");this._dialog.wcfDialog("render")}else{this._proxy.setOption("data",{actionName:"getFileList",className:"cms\\data\\file\\FileAction",parameters:{categoryID:a,fileType:this._options.fileType}});this._proxy.sendRequest()}},_openPicker:function(){if(this._dialog===null){this._proxy.setOption("data",{actionName:"getFileList",className:"cms\\data\\file\\FileAction",parameters:{fileType:this._options.fileType}});this._proxy.sendRequest()}else this._dialog.wcfDialog("open")},_reload:function(){this._dialog.find(".tabularBox").remove();this._openCategory(this._currentlyOpenCategory)},_submit:function(b){var a=$(b.currentTarget);if(this._options.multiple){var c=this;$.each(this._selected,function(b){$('<input type="hidden" name="'+c._inputName+'[]" value="'+b+'" />').appendTo(a)})}else{var e=Object.keys(this._selected),d=this._selected[e[0]];$('<input type="hidden" name="'+this._inputName+'" value="'+d.fileID+'" />').appendTo(a)}},_success:function(a){if(this._dialog===null){this._dialog=$(a.returnValues.template).hide();this._dialog.find(".filePickerCategoryDropdown li").click($.proxy(this._dropdownCategoryClick,this));this._currentlyOpenCategory=a.returnValues.categoryID;this._dialog.appendTo("body");this._dialog.wcfDialog({title:a.returnValues.title});CMS.ACP.File.Upload.init($.proxy(this._uploadCallback,this))}else{$(a.returnValues.template).hide().appendTo(this._dialog);this._openCategory(a.returnValues.categoryID)}this._dialog.find("td.columnMark").each($.proxy(function(e,d){var c=$(d),b=c.parent().data("fileID"),a;if(this._options.multiple)a=$('<input type="checkbox" name="'+this._inputName+'Picker[]" value="'+b+'" />').appendTo(c);else a=$('<input type="radio" name="'+this._inputName+'Picker" value="'+b+'" />').appendTo(c);this._selected[b]!==undefined&&a.prop("checked",true);a.click($.proxy(this._inputClick,this))},this))},_updateSelectedFilesList:function(){var a=this._selectButton.parent().children(".formAttachmentList");a.html("");$.each(this._selected,function(c,b){$('<li class="box32"><span class="icon icon32 icon-paperclip" /><div><div><p>'+b.title+"</p><small>"+b.formattedFilesize+"</small></div></div></li>").appendTo(a)})},_uploadCallback:function(a){this.selectFiles(a,false);this._reload()}});CMS.ACP.File.Preview=WCF.Popover.extend({_proxy:null,init:function(){this._super(".cmsFileLink");this._proxy=new WCF.Action.Proxy({showLoadingOverlay:false})},_loadContent:function(){var b=$("#"+this._activeElementID);this._proxy.setOption("data",{actionName:"getFilePreview",className:"cms\\data\\file\\FileAction",objectIDs:[b.data("fileID")]});var a=this._activeElementID,c=this;this._proxy.setOption("success",function(b){c._insertContent(a,b.returnValues.template,true)});this._proxy.sendRequest()}});CMS.ACP.File.Upload={_afterSubmit:null,_categoryInput:null,_dialog:null,_files:null,_proxy:null,_submitButton:null,init:function(a){this._afterSubmit=a||null;this._files={};this._proxy=new WCF.Action.Proxy;$(".jsFileUploadButton").click($.proxy(this._openDialog,this))},addFile:function(a){this._files[a.fileID]=a;this._handleButtonState()},redraw:function(){this._dialog!==null&&this._dialog.wcfDialog("render")},_finalizeUpload:function(b){b.preventDefault();if($.isEmptyObject(this._files)){console.log("[CMS.ACP.File.Upload] Tried to finalize upload though no files where uploaded, aborting.");return}var a=this._categoryInput.val();if(a===null){console.debug("[CMS.ACP.File.Upload] Tried to finalize upload without a selected category, aborting.");return}this._submitButton.attr("disabled","disabled");this._proxy.setOption("data",{actionName:"update",className:"cms\\data\\file\\FileAction",objectIDs:Object.keys(this._files),parameters:{categoryIDs:a}});this._proxy.setOption("success",$.proxy(function(){this._dialog.wcfDialog("close");new WCF.PeriodicalExecuter($.proxy(function(a){this._dialog.parents(".dialogContainer").remove();this._dialog=null;a.stop()},this),200);$.isFunction(this._afterSubmit)&&this._afterSubmit(this._files)},this));this._proxy.sendRequest()},_handleButtonState:function(){if($.isEmptyObject(this._files)){this._submitButton.prop("disabled",true);return}if(this._categoryInput.val()===null){this._submitButton.prop("disabled",true);return}this._submitButton.prop("disabled",false)},_openDialog:function(){if(this._dialog===null){this._proxy.setOption("data",{actionName:"getUploadDialog",className:"cms\\data\\file\\FileAction"});this._proxy.setOption("success",$.proxy(this._openDialogResponse,this));this._proxy.sendRequest()}else this._dialog.wcfDialog("render")},_openDialogResponse:function(a){this._dialog=$(a.returnValues.template).hide().appendTo("body");this._categoryInput=$("#categoryIDs");this._categoryInput.change($.proxy(this._handleButtonState,this));this._submitButton=$("#fileUploadSubmitButton");this._submitButton.click($.proxy(this._finalizeUpload,this));new CMS.ACP.File.Upload.Handler;this._dialog.wcfDialog({title:a.returnValues.title})}};CMS.ACP.File.Upload.Handler=WCF.Upload.Parallel.extend({init:function(){this._super($("#fileUploadButton"),$(".fileUpload ul"),"cms\\data\\file\\FileAction")},_error:function(c,b,a){console.log(c,b,a)},_initFile:function(a){$li=$('<li class="box32"><span class="icon icon32 icon-spinner" /><div><div><p>'+a.name+'</p><small><progress max="100"></progress></small></div></div></li>').appendTo(this._fileListSelector);CMS.ACP.File.Upload.redraw();return $li},_success:function(b,c){var a=this._uploadMatrix[b];a.find("progress").remove();if(c.returnValues.files[b]){var e=c.returnValues.files[b];CMS.ACP.File.Upload.addFile(e);a.children(".icon-spinner").removeClass("icon-spinner").addClass("icon-paperclip");a.find("small").append(e.formattedFilesize)}else{var d="uploadFailed";if(c.returnValues.errors[b])d=c.returnValues.errors[b].errorType;a.children(".icon-spinner").removeClass("icon-spinner").addClass("icon-ban-circle");a.find("div > div").append($('<small class="innerError">'+WCF.Language.get("cms.acp.file.error."+d)+"</small>"));a.addClass("uploadFailed")}a.css("display","block");CMS.ACP.File.Upload.redraw();WCF.DOMNodeInsertedHandler.execute()}});CMS.ACP.Page={};CMS.ACP.Page.Alias={};CMS.ACP.Page.Alias.Preview=Class.extend({_aliasInput:null,_dummyPageLink:"",_parentPageSelect:null,init:function(c,a,b){this._dummyPageLink=b;this._aliasInput=$(c);this._parentPageSelect=$(a);if(!this._aliasInput.length){console.debug("[CMS.ACP.Page.Alias.Preview] Invalid alias input selector given, aborting.");return}this._previewElement=this._aliasInput.parent().find(".jsAliasPreview");if(!this._previewElement.length){console.debug("[CMS.ACP.Page.Alias.Preview] Unable to find preview element, aborting.");return}this._aliasInput.keyup($.proxy(this._change,this));!this._parentPageSelect.length&&this._parentPageSelect.change($.proxy(this._change,this));this._change()},_change:function(){var b="",c=this._aliasInput.val(),a="";if(!this._parentPageSelect.length)b=this._parentPageSelect.children("option:selected").data("alias");if(c!=""){if(b)a+=b+"/";a+=c;this._previewElement.html(this._dummyPageLink.replace("123456789",a)).show()}else this._previewElement.hide()}});CMS.ACP.Page.Menu=Class.extend({init:function(){$("#menuItemParameters").change($.proxy(this._showNotice,this));$("#menuItemController").change($.proxy(this._showNotice,this));$("#menuItemParametersContainer > dd").append('<p id="cmsNoticeContainer" />');this._showNotice()},_showNotice:function(){if($("#menuItemController").val()=="cms\\page\\PagePage")$("#cmsNoticeContainer").html("<small>"+WCF.Language.get("wcf.acp.pageMenu.parameters.notice")+"</small>");else $("#cmsNoticeContainer").html("")}});CMS.ACP.Page.Revisions=Class.extend({_proxy:null,_cache:{},_dialog:null,init:function(){this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});this._buttons=$(".jsRevisionsButton");this._buttons.click($.proxy(this._click,this));new WCF.Action.Delete("cms\\data\\page\\revision\\PageRevisionAction",".jsRevisionRow")},_click:function(a){a.preventDefault();var b=$(a.currentTarget).data("objectID");this._proxy.setOption("data",{actionName:"getRevisions",className:"cms\\data\\page\\PageAction",objectIDs:[b]});this._proxy.sendRequest()},_show:function(a){this._dialog=$('<div id="revisionDialog">'+this._cache[a]+"</div>").appendTo(document.body);this._dialog.wcfDialog({title:WCF.Language.get("cms.acp.page.revision.list")})},_success:function(a){this._cache[a.returnValues.pageID]=a.returnValues.template;this._show(a.returnValues.pageID)}});CMS.ACP.Page.Revisions.Restore=Class.extend({_proxy:null,_didInit:false,init:function(){if(this._didInit)return;this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});this._buttons=$(".jsRestoreRevisionButton");this._buttons.click($.proxy(this._click,this));this._didInit=true},_click:function(b){b.preventDefault();var a=$(b.currentTarget);if(a.data("confirmMessage"))WCF.System.Confirmation.show(a.data("confirmMessage"),$.proxy(this._execute,this),{target:a});else{WCF.LoadingOverlayHandler.updateIcon(a);this._sendRequest(a)}},_sendRequest:function(a){$versionID=$(a).data("objectID");this._proxy.setOption("data",{actionName:"restore",className:"cms\\data\\page\\revision\\PageRevisionAction",objectIDs:[$versionID]});this._proxy.sendRequest()},_execute:function(b,a){if(b==="cancel")return;WCF.LoadingOverlayHandler.updateIcon(a.target);this._sendRequest(a.target)},_success:function(){var a=new WCF.System.Notification(WCF.Language.get("wcf.global.success"));a.show(function(){window.location=location})}})